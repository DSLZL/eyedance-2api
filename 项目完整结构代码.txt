é¡¹ç›® 'eyedance-2api' çš„ç»“æ„æ ‘:
ğŸ“‚ eyedance-2api/
    ğŸ“„ .env
    ğŸ“„ .env.example
    ğŸ“„ Dockerfile
    ğŸ“„ README.md
    ğŸ“„ docker-compose.yml
    ğŸ“„ main.py
    ğŸ“„ nginx.conf
    ğŸ“„ requirements.txt
    ğŸ“‚ app/
        ğŸ“‚ core/
            ğŸ“„ __init__.py
            ğŸ“„ config.py
        ğŸ“‚ providers/
            ğŸ“„ __init__.py
            ğŸ“„ base_provider.py
            ğŸ“„ eyedance_provider.py
        ğŸ“‚ utils/
            ğŸ“„ oss_uploader.py
    ğŸ“‚ static/
        ğŸ“„ index.html
        ğŸ“„ script.js
        ğŸ“„ style.css
================================================================================

--- æ–‡ä»¶è·¯å¾„: .env ---

# [è‡ªåŠ¨å¡«å……] eyedance-2api ç”Ÿäº§ç¯å¢ƒé…ç½®
# è¯¥æ–‡ä»¶ç”± Genesis Protocol Â· Î© (Omega) ç‰ˆè‡ªåŠ¨ç”Ÿæˆã€‚

# --- å®‰å…¨é…ç½® ---
# ç”¨äºä¿æŠ¤æ‚¨çš„ API æœåŠ¡çš„è®¿é—®å¯†é’¥ï¼Œè¯·æŒ‰éœ€ä¿®æ”¹ä¸ºæ‚¨è‡ªå·±çš„å¤æ‚å¯†é’¥ã€‚
API_MASTER_KEY=1

# --- ç«¯å£é…ç½® ---
# Nginx å¯¹å¤–æš´éœ²çš„ç«¯å£
NGINX_PORT=8089


--- æ–‡ä»¶è·¯å¾„: .env.example ---

# ====================================================================
# eyedance-2api é…ç½®æ–‡ä»¶æ¨¡æ¿
# ====================================================================
#
# è¯·å°†æ­¤æ–‡ä»¶é‡å‘½åä¸º ".env" å¹¶å¡«å…¥æ‚¨çš„é…ç½®ã€‚
#

# --- æ ¸å¿ƒå®‰å…¨é…ç½® (å¿…é¡»è®¾ç½®) ---
# ç”¨äºä¿æŠ¤æ‚¨ API æœåŠ¡çš„è®¿é—®å¯†é’¥ã€‚
API_MASTER_KEY=sk-eyedance-2api-default-key-please-change-me

# --- éƒ¨ç½²é…ç½® (å¯é€‰) ---
# Nginx å¯¹å¤–æš´éœ²çš„ç«¯å£
NGINX_PORT=8089


--- æ–‡ä»¶è·¯å¾„: Dockerfile ---

# ====================================================================
# Dockerfile for eyedance-2api (v2.0 - Concurrent & Parametric)
# ====================================================================

FROM python:3.10-slim

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
WORKDIR /app

# å®‰è£… Python ä¾èµ–
COPY requirements.txt .
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY . .

# åˆ›å»ºå¹¶åˆ‡æ¢åˆ°é root ç”¨æˆ·
RUN useradd --create-home appuser && \
    chown -R appuser:appuser /app
USER appuser

# æš´éœ²ç«¯å£å¹¶å¯åŠ¨ (ä¿®æ­£ï¼šç§»é™¤ --workers å‚æ•°ï¼Œä½¿ç”¨å•è¿›ç¨‹æ¨¡å¼)
EXPOSE 8000
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]


--- æ–‡ä»¶è·¯å¾„: README.md ---

# Qwen Multi-Account Local API (v7.2)

è¿™æ˜¯ä¸€ä¸ªåŸºäº FastAPI çš„é«˜æ€§èƒ½é€šä¹‰åƒé—®æœ¬åœ°ä»£ç†æœåŠ¡ã€‚å®ƒä¸ä»…å°†ç½‘é¡µç‰ˆAPIå°è£…æˆæ ‡å‡†æ¥å£ï¼Œè¿˜æ”¯æŒ**å¤šè´¦å·è½®è¯¢**ã€**æ¨¡å‹ç­–ç•¥è·¯ç”±**å’Œ**å¯†é’¥è®¤è¯**ç­‰é«˜çº§åŠŸèƒ½ã€‚

## âœ¨ æ ¸å¿ƒç‰¹æ€§

-   **å¤šè´¦å·æ”¯æŒ**: å¯é…ç½®å¤šä¸ªå›½å†…ç«™è´¦å·ï¼Œå¹¶é€šè¿‡ç­–ç•¥è·¯ç”±å°†ç‰¹å®šæ¨¡å‹ï¼ˆå¦‚`Qwen3-Max-Preview`ï¼‰çš„è¯·æ±‚å®šå‘åˆ°ä¸“å±è´¦å·ã€‚
-   **é«˜ç¨³å®šæ€§**: åŸºäºä¸ªäººé•¿æœŸæœ‰æ•ˆçš„è®¤è¯ä¿¡æ¯ï¼ŒæœåŠ¡ç¨³å®šå¯é ã€‚
-   **å…¨åŠŸèƒ½è¦†ç›–**: æ”¯æŒæ–‡æœ¬ã€è§†è§‰ã€ä»¥åŠå›½é™…ç«™çš„å›¾åƒå’Œè§†é¢‘ç”Ÿæˆæ¨¡å‹ã€‚
-   **ä¼ä¸šçº§å®‰å…¨**: å†…ç½®`API_MASTER_KEY`è®¤è¯ï¼Œä¿æŠ¤æ‚¨çš„APIæœåŠ¡ä¸è¢«æ»¥ç”¨ã€‚
-   **é«˜æ€§èƒ½æ¶æ„**: é‡‡ç”¨ FastAPI + å¼‚æ­¥IOï¼Œä¸ºé«˜å¹¶å‘è€Œç”Ÿã€‚
-   **ä¸€é”®éƒ¨ç½²**: æä¾›ç»ˆæç®€åŒ–çš„ Docker Compose é…ç½®ï¼ŒçœŸæ­£å®ç°ä¸€é”®å¯åŠ¨ã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å‡†å¤‡è®¤è¯ä¿¡æ¯

æœ¬é¡¹ç›®ä¾èµ–é€šä¹‰åƒé—®ç½‘é¡µç‰ˆçš„è®¤è¯ä¿¡æ¯ã€‚è¯·ç™»å½• **[é€šä¹‰åƒé—®å®˜ç½‘](https://tongyi.aliyun.com/chat)**ï¼Œç„¶åæŒ‰ `F12` æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼Œåœ¨**ç½‘ç»œ(Network)**é¢æ¿éšä¾¿å‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œä» `completions` è¯·æ±‚çš„**è¯·æ±‚å¤´(Request Headers)**ä¸­æ‰¾åˆ°å¹¶å¤åˆ¶ä»¥ä¸‹ä¸¤é¡¹ï¼š

-   `cookie`
-   `x-xsrf-token`

*ï¼ˆå¦‚æœæ‚¨éœ€è¦ä½¿ç”¨ä¸“å±è´¦å·æˆ–å›½é™…ç«™åŠŸèƒ½ï¼Œè¯·ç”¨åŒæ ·çš„æ–¹æ³•è·å–å¯¹åº”è´¦å·çš„è®¤è¯ä¿¡æ¯ã€‚ï¼‰*

### 2. é…ç½®é¡¹ç›®

åœ¨ `qwen-local` æ–‡ä»¶å¤¹ä¸­ï¼Œå°† `.env.example` æ–‡ä»¶é‡å‘½åä¸º `.env`ï¼Œç„¶åæ‰“å¼€å®ƒï¼Œå¡«å…¥æ‚¨åˆšåˆšè·å–çš„ä¿¡æ¯ã€‚

LISTEN_PORT=8082
API_MASTER_KEY=1
MODEL_TO_ACCOUNT_MAP='{}' # ç•™ç©ºå³å¯
CN_ACCOUNT_1_COOKIE="ä½ çš„token"
CN_ACCOUNT_1_XSRF_TOKEN="ä½ çš„token"
CN_ACCOUNT_2_COOKIE="ä½ çš„token"
CN_ACCOUNT_2_XSRF_TOKEN="ä½ çš„token"
title: Qwen
emoji: ğŸ’»
colorFrom: green
colorTo: indigo
sdk: docker
pinned: false
license: other
short_description: Qwen  free API
app_port: 8000

--- æ–‡ä»¶è·¯å¾„: docker-compose.yml ---

services:
  nginx:
    image: nginx:latest
    container_name: eyedance-2api-nginx
    restart: always
    ports:
      - "${NGINX_PORT:-8089}:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - app
    networks:
      - eyedance-net

  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: eyedance-2api-app
    restart: unless-stopped
    env_file:
      - .env
    networks:
      - eyedance-net

networks:
  eyedance-net:
    driver: bridge


--- æ–‡ä»¶è·¯å¾„: main.py ---

import logging
import time
import uuid
from contextlib import asynccontextmanager
from typing import Optional, Dict, Any

from fastapi import FastAPI, Request, HTTPException, Depends, Header
from fastapi.responses import JSONResponse, HTMLResponse
from fastapi.staticfiles import StaticFiles

from app.core.config import settings
from app.providers.eyedance_provider import EyeDanceProvider

# --- æ—¥å¿—é…ç½® ---
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(name)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

# --- å…¨å±€ Provider å®ä¾‹ ---
provider = EyeDanceProvider()

@asynccontextmanager
async def lifespan(app: FastAPI):
    logger.info(f"åº”ç”¨å¯åŠ¨ä¸­... {settings.APP_NAME} v{settings.APP_VERSION}")
    logger.info("æœåŠ¡å·²è¿›å…¥ 'Cloudscraper' æ¨¡å¼ï¼Œå°†è‡ªåŠ¨å¤„ç†æ½œåœ¨çš„ Cloudflare æŒ‘æˆ˜ã€‚")
    logger.info(f"API æœåŠ¡å°†åœ¨ http://localhost:{settings.NGINX_PORT} ä¸Šå¯ç”¨")
    logger.info(f"Web UI æµ‹è¯•ç•Œé¢å·²å¯ç”¨ï¼Œè¯·è®¿é—® http://localhost:{settings.NGINX_PORT}/")
    yield
    logger.info("åº”ç”¨å…³é—­ã€‚")

app = FastAPI(
    title=settings.APP_NAME,
    version=settings.APP_VERSION,
    description=settings.DESCRIPTION,
    lifespan=lifespan
)

# --- æŒ‚è½½é™æ€æ–‡ä»¶ç›®å½• ---
app.mount("/static", StaticFiles(directory="static"), name="static")

# --- å®‰å…¨ä¾èµ– ---
async def verify_api_key(authorization: Optional[str] = Header(None)):
    if settings.API_MASTER_KEY and settings.API_MASTER_KEY != "1":
        if not authorization or "bearer" not in authorization.lower():
            raise HTTPException(status_code=401, detail="éœ€è¦ Bearer Token è®¤è¯ã€‚")
        token = authorization.split(" ")[-1]
        if token != settings.API_MASTER_KEY:
            raise HTTPException(status_code=403, detail="æ— æ•ˆçš„ API Keyã€‚")

# --- API è·¯ç”± ---
@app.post("/v1/images/generations", dependencies=[Depends(verify_api_key)])
async def image_generations(request: Request):
    try:
        request_data = await request.json()
        image_result_dict = await provider.generate_image(request_data)
        return JSONResponse(content=image_result_dict)
    except Exception as e:
        logger.error(f"å¤„ç†å›¾åƒç”Ÿæˆè¯·æ±‚æ—¶å‘ç”Ÿé¡¶å±‚é”™è¯¯: {e}", exc_info=True)
        if isinstance(e, HTTPException):
            raise e
        raise HTTPException(status_code=500, detail=f"å†…éƒ¨æœåŠ¡å™¨é”™è¯¯: {str(e)}")

@app.post("/v1/chat/completions", dependencies=[Depends(verify_api_key)])
async def chat_completions(request: Request):
    try:
        request_data = await request.json()
        
        messages = request_data.get("messages", [])
        if not messages:
            raise HTTPException(status_code=400, detail="è¯·æ±‚ä½“ä¸­ç¼ºå°‘ 'messages' å­—æ®µã€‚")
        
        last_user_message = next((m['content'] for m in reversed(messages) if m.get('role') == 'user'), None)
        if not last_user_message:
            raise HTTPException(status_code=400, detail="åœ¨ 'messages' ä¸­æœªæ‰¾åˆ°ç”¨æˆ·æ¶ˆæ¯ã€‚")

        # ä»èŠå¤©è¯·æ±‚ä¸­è·å–æ¨¡å‹åç§°ï¼Œå¦‚æœæœªæä¾›åˆ™ä½¿ç”¨é»˜è®¤å€¼
        model_name = request_data.get("model", settings.DEFAULT_MODEL)

        image_request_data = {
            "prompt": last_user_message,
            "model": model_name,  # å°†æ¨¡å‹åç§°ä¼ é€’ç»™å›¾åƒç”Ÿæˆå™¨
            "n": 1,
            "size": "600x450",
            "steps": 20,
            "response_format": "b64_json"
        }
        
        logger.info(f"é€šè¿‡èŠå¤©æ¥å£é€‚é…å›¾åƒç”Ÿæˆï¼Œä½¿ç”¨æ¨¡å‹ '{model_name}' å’Œ prompt: '{last_user_message[:50]}...'")
        image_result_dict = await provider.generate_image(image_request_data)

        if not image_result_dict.get("data") or not image_result_dict["data"][0].get("b64_json"):
            raise HTTPException(status_code=502, detail="ä»ä¸Šæ¸¸æœåŠ¡ç”Ÿæˆå›¾åƒå¤±è´¥ã€‚")
            
        b64_json = image_result_dict["data"][0]["b64_json"]
        
        response_content = f"![](data:image/png;base64,{b64_json})"
        
        chat_response = {
            "id": f"chatcmpl-{uuid.uuid4()}",
            "object": "chat.completion",
            "created": int(time.time()),
            "model": model_name,  # åœ¨å“åº”ä¸­ä¹Ÿä½¿ç”¨è¯·æ±‚çš„æ¨¡å‹åç§°
            "choices": [{
                "index": 0,
                "message": {
                    "role": "assistant",
                    "content": response_content,
                },
                "finish_reason": "stop",
            }],
            "usage": {
                "prompt_tokens": 0,
                "completion_tokens": 0,
                "total_tokens": 0,
            }
        }
        
        return JSONResponse(content=chat_response)

    except Exception as e:
        logger.error(f"å¤„ç†èŠå¤©ç”Ÿæˆè¯·æ±‚æ—¶å‘ç”Ÿé¡¶å±‚é”™è¯¯: {e}", exc_info=True)
        if isinstance(e, HTTPException):
            raise e
        raise HTTPException(status_code=500, detail=f"å†…éƒ¨æœåŠ¡å™¨é”™è¯¯: {str(e)}")


@app.get("/v1/models", dependencies=[Depends(verify_api_key)])
async def list_models():
    """è¿”å›å¯ç”¨æ¨¡å‹åˆ—è¡¨"""
    model_data = await provider.get_models()
    return model_data

# --- Web UI è·¯ç”± ---
@app.get("/", response_class=HTMLResponse, include_in_schema=False)
async def serve_ui():
    try:
        with open("static/index.html", "r", encoding="utf-8") as f:
            return HTMLResponse(content=f.read())
    except FileNotFoundError:
        raise HTTPException(status_code=404, detail="UI æ–‡ä»¶ (static/index.html) æœªæ‰¾åˆ°ã€‚")


--- æ–‡ä»¶è·¯å¾„: nginx.conf ---

worker_processes auto;

events {
    worker_connections 1024;
}

http {
    upstream eyedance_backend {
        # ip_hash ä¿è¯æ¥è‡ªåŒä¸€å®¢æˆ·ç«¯çš„è¯·æ±‚è¢«è½¬å‘åˆ°åŒä¸€ä¸ª worker
        # åœ¨å• worker æ¨¡å¼ä¸‹ï¼Œæ­¤é¡¹ä½œç”¨ä¸å¤§ï¼Œä½†ä¿ç•™ä»¥å¤‡å°†æ¥æ‰©å±•
        ip_hash;
        server app:8000;
    }

    server {
        listen 80;
        server_name localhost;

        # å…è®¸æ›´å¤§çš„è¯·æ±‚ä½“ï¼Œä»¥é˜² prompt è¿‡é•¿
        client_max_body_size 10M;

        location / {
            proxy_pass http://eyedance_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # æµå¼ä¼ è¾“ä¼˜åŒ– (è™½ç„¶æ­¤APIéæµå¼ï¼Œä½†ä¿ç•™æ˜¯è‰¯å¥½å®è·µ)
            proxy_buffering off;
            proxy_cache off;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            chunked_transfer_encoding off;
        }
    }
}


--- æ–‡ä»¶è·¯å¾„: requirements.txt ---

fastapi
uvicorn[standard]
pydantic-settings
python-dotenv
cloudscraper
aiohttp
asyncio


--- æ–‡ä»¶è·¯å¾„: app\core\__init__.py ---



--- æ–‡ä»¶è·¯å¾„: app\core\config.py ---

from pydantic_settings import BaseSettings, SettingsConfigDict
from typing import Optional, List

class Settings(BaseSettings):
    model_config = SettingsConfigDict(
        env_file=".env",
        env_file_encoding='utf-8',
        extra="ignore"
    )

    APP_NAME: str = "eyedance-2api"
    APP_VERSION: str = "2.0.0"
    DESCRIPTION: str = "ä¸€ä¸ªå°† eyedance.net è½¬æ¢ä¸ºå…¼å®¹ OpenAI æ ¼å¼ API çš„é«˜æ€§èƒ½å¹¶å‘ä»£ç†ã€‚"

    API_MASTER_KEY: Optional[str] = None
    NGINX_PORT: int = 8089

    # ä¸Šæ¸¸è¯·æ±‚é…ç½®
    API_REQUEST_TIMEOUT: int = 180
    UPSTREAM_MAX_RETRIES: int = 3
    UPSTREAM_RETRY_DELAY: int = 2 # ç§’

    # æ¨¡å‹é…ç½®
    DEFAULT_MODEL: str = "eyedance-qwen-image"
    # æ–°å¢ "Flux-Krea" æ¨¡å‹
    KNOWN_MODELS: List[str] = ["eyedance-qwen-image", "Flux-Krea"]
    UPSTREAM_MODEL_NAME: str = "Qwen-Image"

settings = Settings()


--- æ–‡ä»¶è·¯å¾„: app\providers\__init__.py ---



--- æ–‡ä»¶è·¯å¾„: app\providers\base_provider.py ---

from abc import ABC, abstractmethod
from typing import Dict, Any
from fastapi.responses import JSONResponse

class BaseProvider(ABC):
    @abstractmethod
    async def generate_image(self, request_data: Dict[str, Any]) -> JSONResponse:
        pass

    @abstractmethod
    async def get_models(self) -> JSONResponse:
        pass


--- æ–‡ä»¶è·¯å¾„: app\providers\eyedance_provider.py ---

import time
import logging
import random
import asyncio
from typing import Dict, Any, Optional, Tuple

import cloudscraper
from fastapi import HTTPException

from app.core.config import settings
from app.providers.base_provider import BaseProvider

logger = logging.getLogger(__name__)

class EyeDanceProvider(BaseProvider):
    BASE_URL = "https://eyedance.net/api/generate"

    def __init__(self):
        self.scraper = cloudscraper.create_scraper()

    def _prepare_headers(self, model_name: str) -> Dict[str, str]:
        """æ ¹æ®æ¨¡å‹åç§°åŠ¨æ€ç”Ÿæˆè¯·æ±‚å¤´"""
        referer = "https://eyedance.net/"
        cookie = None

        # ä¸º Flux-Krea æ¨¡å‹è®¾ç½®ç‰¹å®šçš„ Referer å’Œ Cookie
        if model_name == "Flux-Krea":
            referer = "https://eyedance.net/es/flux-krea"
            cookie = "NEXT_LOCALE=es; active_theme=default"

        headers = {
            "Accept": "application/json, text/plain, */*",
            "Accept-Language": "zh-CN,zh;q=0.9,en;q=0.8",
            "Content-Type": "application/json",
            "Origin": "https://eyedance.net",
            "Referer": referer,
            "sec-ch-ua": '"Google Chrome";v="141", "Not?A_Brand";v="8", "Chromium";v="141"',
            "sec-ch-ua-mobile": "?0",
            "sec-ch-ua-platform": '"Windows"',
        }
        if cookie:
            headers["Cookie"] = cookie
        return headers

    def _parse_size(self, size: Optional[str]) -> Tuple[int, int]:
        if not size or 'x' not in size:
            return 600, 450
        try:
            width, height = map(int, size.split('x'))
            return width, height
        except (ValueError, TypeError):
            logger.warning(f"æ— æ•ˆçš„ size å‚æ•°: '{size}', ä½¿ç”¨é»˜è®¤å€¼ 600x450")
            return 600, 450

    async def _send_single_request(self, payload: Dict[str, Any]) -> str:
        loop = asyncio.get_running_loop()
        # ä» payload ä¸­è·å–æ¨¡å‹åç§°ä»¥ç”Ÿæˆæ­£ç¡®çš„è¯·æ±‚å¤´
        model_name = payload.get("model", settings.DEFAULT_MODEL)
        headers = self._prepare_headers(model_name)
        
        for attempt in range(settings.UPSTREAM_MAX_RETRIES):
            try:
                response = await loop.run_in_executor(
                    None, 
                    lambda: self.scraper.post(
                        self.BASE_URL,
                        headers=headers,
                        json=payload,
                        timeout=settings.API_REQUEST_TIMEOUT
                    )
                )
                
                if response.status_code >= 500:
                    logger.warning(f"ä¸Šæ¸¸è¿”å› {response.status_code} é”™è¯¯ï¼Œæ­£åœ¨é‡è¯•... (å°è¯• {attempt + 1}/{settings.UPSTREAM_MAX_RETRIES})")
                    raise ConnectionError(f"Upstream {response.status_code} Error")

                response.raise_for_status()
                response_json = response.json()

                if "error" in response_json and response_json["error"] == "fetch failed":
                    logger.warning(f"ä¸Šæ¸¸è¿”å› 'fetch failed'ï¼Œæ­£åœ¨é‡è¯•... (å°è¯• {attempt + 1}/{settings.UPSTREAM_MAX_RETRIES})")
                    raise ConnectionError("Upstream fetch failed")

                image_url = response_json.get("imageUrl")
                if not image_url or not image_url.startswith("data:image/png;base64,"):
                    raise ValueError("ä¸Šæ¸¸ API æœªè¿”å›æœ‰æ•ˆçš„ Base64 å›¾åƒæ•°æ®ã€‚")

                return image_url.split(',', 1)[1]

            except Exception as e:
                logger.error(f"è¯·æ±‚ä¸Šæ¸¸å¤±è´¥ (å°è¯• {attempt + 1}): {e}")
                if attempt < settings.UPSTREAM_MAX_RETRIES - 1:
                    await asyncio.sleep(settings.UPSTREAM_RETRY_DELAY)
                else:
                    raise e
        
        raise ConnectionError("æ‰€æœ‰é‡è¯•å‡å¤±è´¥ã€‚")

    async def generate_image(self, request_data: Dict[str, Any]) -> Dict[str, Any]:
        prompt = request_data.get("prompt")
        if not prompt:
            raise HTTPException(status_code=400, detail="å‚æ•° 'prompt' ä¸èƒ½ä¸ºç©ºã€‚")

        # ä»è¯·æ±‚ä¸­è·å–æ¨¡å‹ï¼Œå¦‚æœæœªæä¾›åˆ™ä½¿ç”¨é»˜è®¤æ¨¡å‹
        model_name = request_data.get("model", settings.DEFAULT_MODEL)
        if model_name not in settings.KNOWN_MODELS:
            raise HTTPException(status_code=400, detail=f"ä¸æ”¯æŒçš„æ¨¡å‹: '{model_name}'. å¯ç”¨æ¨¡å‹: {settings.KNOWN_MODELS}")

        # å¦‚æœæ˜¯ Flux-Krea æ¨¡å‹ï¼Œè®°å½•ä¸€ä¸ªè­¦å‘Šï¼ˆå› ä¸ºè¯¥æ¨¡å‹ä¸»è¦ç”¨äºè‹±æ–‡ï¼‰
        if model_name == "Flux-Krea":
            try:
                prompt.encode('ascii')
            except UnicodeEncodeError:
                logger.warning("æ¨¡å‹ 'Flux-Krea' å¼ºçƒˆå»ºè®®ä½¿ç”¨è‹±æ–‡æç¤ºè¯ï¼Œæ£€æµ‹åˆ°éè‹±æ–‡å­—ç¬¦ï¼Œç”Ÿæˆæ•ˆæœå¯èƒ½ä¸ä½³ã€‚")

        width, height = self._parse_size(request_data.get("size"))
        num_images = request_data.get("n", 1)
        steps = request_data.get("steps", 20)

        tasks = []
        for _ in range(num_images):
            payload = {
                "prompt": prompt,
                "width": width,
                "height": height,
                "steps": steps,
                "batch_size": 1,
                "model": model_name,  # ä½¿ç”¨ä»è¯·æ±‚ä¸­è·å–çš„åŠ¨æ€æ¨¡å‹
                "seed": random.randint(0, 1_000_000)
            }
            tasks.append(self._send_single_request(payload))
        
        logger.info(f"å‡†å¤‡å‘ä¸Šæ¸¸å¹¶å‘å‘é€ {num_images} ä¸ª '{model_name}' æ¨¡å‹è¯·æ±‚...")

        try:
            results = await asyncio.gather(*tasks)
            
            response_data = {
                "created": int(time.time()),
                "data": [{"b64_json": b64_json} for b64_json in results]
            }
            return response_data

        except Exception as e:
            logger.error(f"å¤„ç†å¹¶å‘è¯·æ±‚æ—¶å‘ç”Ÿä¸¥é‡é”™è¯¯: {e}", exc_info=True)
            raise HTTPException(status_code=502, detail=f"ä¸Šæ¸¸æœåŠ¡é”™è¯¯æˆ–æ‰€æœ‰é‡è¯•å‡å¤±è´¥: {str(e)}")

    async def get_models(self) -> Dict[str, Any]:
        model_data = {
            "object": "list",
            "data": [
                {"id": name, "object": "model", "created": int(time.time()), "owned_by": "lzA6"}
                for name in settings.KNOWN_MODELS
            ]
        }
        return model_data


--- æ–‡ä»¶è·¯å¾„: app\utils\oss_uploader.py ---

import oss2
import uuid
import logging
import asyncio
from typing import Dict
from urllib.parse import urlparse

logger = logging.getLogger(__name__)

class OSSImageUploader:
    def __init__(self, scraper_session, headers: Dict[str, str]):
        self.scraper = scraper_session
        self.headers = headers
        self.sts_token_url = "https://visualgpt.io/api/v1/oss/sts-token"
        self.oss_endpoint = "https://oss-us-west-1.aliyuncs.com"
        self.bucket_name = "nc-cdn"
        self.upload_path_prefix = "visualgpt/user-upload/"
        self.cdn_base_url = "https://cdn.visualgpt.io/"

    async def _get_sts_token(self) -> Dict:
        """
        å¼‚æ­¥è·å–ä¸´æ—¶çš„é˜¿é‡Œäº‘ OSS STS ä»¤ç‰Œã€‚
        """
        logger.info("æ­£åœ¨è·å–é˜¿é‡Œäº‘ OSS STS ä»¤ç‰Œ...")
        loop = asyncio.get_running_loop()
        try:
            # åœ¨ executor ä¸­è¿è¡ŒåŒæ­¥çš„ scraper è¯·æ±‚
            response = await loop.run_in_executor(
                None, lambda: self.scraper.get(self.sts_token_url, headers=self.headers)
            )
            response.raise_for_status()
            data = response.json()
            if data.get("code") == 100000 and "data" in data:
                logger.info("æˆåŠŸè·å– STS ä»¤ç‰Œã€‚")
                return data["data"]
            else:
                raise Exception(f"è·å– STS ä»¤ç‰Œå¤±è´¥: {data.get('message', 'æœªçŸ¥é”™è¯¯')}")
        except Exception as e:
            logger.error(f"è¯·æ±‚ STS ä»¤ç‰Œæ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯: {e}", exc_info=True)
            raise

    async def upload_image(self, image_bytes: bytes, filename: str) -> str:
        """
        ä½¿ç”¨ STS ä»¤ç‰Œå°†å›¾ç‰‡ä¸Šä¼ åˆ°é˜¿é‡Œäº‘ OSSï¼Œå¹¶è¿”å›æœ€ç»ˆçš„ CDN URLã€‚
        """
        sts_data = await self._get_sts_token()
        
        access_key_id = sts_data.get("AccessKeyId")
        access_key_secret = sts_data.get("AccessKeySecret")
        security_token = sts_data.get("SecurityToken")

        # è¿™ä¸€è¡Œæ˜¯ä¹‹å‰è¢«æˆªæ–­å¹¶å¯¼è‡´é”™è¯¯çš„åœ°æ–¹ï¼Œç°åœ¨å·²è¡¥å…¨ã€‚
        if not all([access_key_id, access_key_secret, security_token]):
            raise Exception("è·å–çš„ STS ä»¤ç‰Œæ— æ•ˆï¼Œç¼ºå°‘å…³é”®å‡­è¯å­—æ®µã€‚")

        # ä½¿ç”¨ STS å‡­è¯è¿›è¡Œè®¤è¯
        auth = oss2.StsAuth(access_key_id, access_key_secret, security_token)
        bucket = oss2.Bucket(auth, self.oss_endpoint, self.bucket_name)

        # ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„æ–‡ä»¶åä»¥é¿å…å†²çª
        file_extension = filename.split('.')[-1] if '.' in filename else 'png'
        object_key = f"{self.upload_path_prefix}{uuid.uuid4()}.{file_extension}"

        logger.info(f"æ­£åœ¨å°†å›¾ç‰‡ä¸Šä¼ åˆ° OSS: {object_key}")

        # å¼‚æ­¥ä¸Šä¼ 
        loop = asyncio.get_running_loop()
        await loop.run_in_executor(
            None, lambda: bucket.put_object(object_key, image_bytes)
        )
        
        # æ„å»ºæœ€ç»ˆå¯é€šè¿‡ CDN è®¿é—®çš„ URL
        final_url = f"{self.cdn_base_url}{object_key}"
        logger.info(f"OSS ä¸Šä¼ æˆåŠŸï¼ŒCDN URL: {final_url}")
        
        return final_url


--- æ–‡ä»¶è·¯å¾„: static\index.html ---

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EyeDance-2API æµ‹è¯•é¢æ¿ v2.1</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="header">
                <h2>EyeDance-2API</h2>
                <p>v2.1 - åŠ¨æ€æ¨¡å‹ç‰ˆ</p>
            </div>

            <div class="form-group">
                <label for="api-key">API Key</label>
                <input type="password" id="api-key" placeholder="è¯·è¾“å…¥æ‚¨çš„ API Key" value="1">
            </div>

            <div class="form-group">
                <label for="model-select">æ¨¡å‹ (Model)</label>
                <select id="model-select"></select>
                <small id="model-warning" class="hidden model-warning">æç¤º: 'Flux-Krea' æ¨¡å‹ä»…å»ºè®®ä½¿ç”¨è‹±æ–‡æç¤ºè¯ã€‚</small>
            </div>

            <div class="form-group">
                <label for="prompt-input">æç¤ºè¯ (Prompt)</label>
                <textarea id="prompt-input" rows="6" placeholder="è¾“å…¥æ‚¨çš„å›¾åƒæè¿°..."></textarea>
            </div>

            <div class="form-group slider-group">
                <div class="slider-label">
                    <label for="width-slider">å®½åº¦ (Width)</label>
                    <span id="width-value">600px</span>
                </div>
                <input type="range" id="width-slider" min="256" max="1920" step="8" value="600">
                <small>è¾ƒå¤§çš„å°ºå¯¸ä¼šæ˜¾è‘—å¢åŠ ç”Ÿæˆæ—¶é—´ã€‚</small>
            </div>

            <div class="form-group slider-group">
                <div class="slider-label">
                    <label for="height-slider">é«˜åº¦ (Height)</label>
                    <span id="height-value">450px</span>
                </div>
                <input type="range" id="height-slider" min="256" max="1920" step="8" value="450">
            </div>

            <div class="form-group slider-group">
                <div class="slider-label">
                    <label for="steps-slider">æ­¥æ•° (Steps)</label>
                    <span id="steps-value">20</span>
                </div>
                <input type="range" id="steps-slider" min="10" max="60" step="1" value="20">
                <small>æ­¥æ•°è¶Šå¤šï¼Œå›¾åƒç»†èŠ‚å¯èƒ½è¶Šä¸°å¯Œï¼Œä½†è€—æ—¶æ›´é•¿ã€‚</small>
            </div>

            <div class="form-group slider-group">
                <div class="slider-label">
                    <label for="count-slider">ç”Ÿæˆæ•°é‡ (Count)</label>
                    <span id="count-value">3</span>
                </div>
                <input type="range" id="count-slider" min="1" max="12" step="1" value="3">
                <small>ä¸€æ¬¡ç”Ÿæˆå¤šå¼ å›¾ç‰‡ä¼šå¹¶å‘è¯·æ±‚ï¼Œè¯·è€å¿ƒç­‰å¾…ã€‚</small>
            </div>

            <button id="generate-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-magic" viewBox="0 0 16 16"><path d="M9.5 2.672a.5.5 0 1 0 1 0V.843a.5.5 0 0 0-1 0v1.829Zm4.5.035A.5.5 0 0 0 13.293 2L12 3.293a.5.5 0 1 0 .707.707L14 2.707a.5.5 0 0 0 0-.707ZM7.293 4L8 3.293a.5.5 0 1 0-.707-.707L6.586 3.293a.5.5 0 1 0 .707.707ZM5 6.293a.5.5 0 1 0-.707-.707L3.586 6.293a.5.5 0 1 0 .707.707L5 6.293Zm6.707.707a.5.5 0 1 0-.707-.707L10.293 7a.5.5 0 1 0 .707.707l.707-.707ZM1.5 10.328a.5.5 0 0 0 1 0V8.5a.5.5 0 0 0-1 0v1.828Zm4.5-.035a.5.5 0 1 0-1 0V12a.5.5 0 0 0 1 0V10.293ZM10 15a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"/></svg>
                <span>ç”Ÿæˆå›¾åƒ</span>
            </button>
        </div>
        <div class="main-content">
            <div id="result-panel">
                <div id="placeholder" class="placeholder">
                    <p>è¯·åœ¨å·¦ä¾§é…ç½®å‚æ•°å¹¶å¼€å§‹ç”Ÿæˆ</p>
                </div>
                <div id="spinner" class="spinner hidden"></div>
                <div id="error-message" class="error hidden"></div>
                <div id="image-grid"></div>
            </div>
        </div>
    </div>
    <script src="/static/script.js"></script>
</body>
</html>

--- æ–‡ä»¶è·¯å¾„: static\script.js ---

document.addEventListener('DOMContentLoaded', () => {
    // DOM Elements
    const apiKeyInput = document.getElementById('api-key');
    const modelSelect = document.getElementById('model-select');
    const modelWarning = document.getElementById('model-warning');
    const promptInput = document.getElementById('prompt-input');
    const generateBtn = document.getElementById('generate-btn');
    
    const widthSlider = document.getElementById('width-slider');
    const widthValue = document.getElementById('width-value');
    const heightSlider = document.getElementById('height-slider');
    const heightValue = document.getElementById('height-value');
    const stepsSlider = document.getElementById('steps-slider');
    const stepsValue = document.getElementById('steps-value');
    const countSlider = document.getElementById('count-slider');
    const countValue = document.getElementById('count-value');

    const imageGrid = document.getElementById('image-grid');
    const spinner = document.getElementById('spinner');
    const errorMessage = document.getElementById('error-message');
    const placeholder = document.getElementById('placeholder');

    // --- Functions ---

    /**
     * Fetches models from the API and populates the dropdown.
     * Manages the disabled state of controls based on success or failure.
     */
    async function populateModels() {
        // 1. Reset and disable controls at the start
        modelSelect.innerHTML = '';
        modelSelect.disabled = true;
        generateBtn.disabled = true;
        hideError();

        const apiKey = apiKeyInput.value.trim();
        if (!apiKey) {
            const placeholderOption = document.createElement('option');
            placeholderOption.textContent = "è¯·è¾“å…¥API Keyä»¥åŠ è½½æ¨¡å‹";
            modelSelect.appendChild(placeholderOption);
            return;
        }

        // 2. Show loading state in the dropdown
        const loadingOption = document.createElement('option');
        loadingOption.textContent = "æ­£åœ¨åŠ è½½æ¨¡å‹...";
        modelSelect.appendChild(loadingOption);

        try {
            const response = await fetch('/v1/models', {
                headers: { 'Authorization': `Bearer ${apiKey}` }
            });
            const result = await response.json();
            if (!response.ok) {
                throw new Error(result.detail || 'è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥ã€‚');
            }
            
            // 3. On success, populate dropdown and enable controls
            modelSelect.innerHTML = ''; // Clear loading message
            result.data.forEach(model => {
                const option = document.createElement('option');
                option.value = model.id;
                option.textContent = model.id;
                modelSelect.appendChild(option);
            });
            
            modelSelect.disabled = false;
            generateBtn.disabled = false;
            handleModelChange(); // Show warning for the initially selected model if needed

        } catch (error) {
            // 4. On failure, show clear error messages
            showError(`æ¨¡å‹åŠ è½½å¤±è´¥: ${error.message}. è¯·æ£€æŸ¥æ‚¨çš„ API Key.`);
            modelSelect.innerHTML = '';
            const errorOption = document.createElement('option');
            errorOption.textContent = "åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥API Key";
            modelSelect.appendChild(errorOption);
        }
    }

    /**
     * Shows or hides the warning for the Flux-Krea model.
     */
    function handleModelChange() {
        const selectedModel = modelSelect.value;
        modelWarning.classList.toggle('hidden', selectedModel !== 'Flux-Krea');
    }

    /**
     * Handles the image generation request on button click.
     */
    async function handleGenerate() {
        const apiKey = apiKeyInput.value.trim();
        const prompt = promptInput.value.trim();
        const selectedModel = modelSelect.value;

        if (!apiKey || !prompt) {
            showError("è¯·ç¡®ä¿ API Key å’Œæç¤ºè¯éƒ½å·²å¡«å†™ã€‚");
            return;
        }
        if (!selectedModel || modelSelect.disabled) {
            showError("æ¨¡å‹æœªæˆåŠŸåŠ è½½æˆ–æœªé€‰æ‹©ï¼Œè¯·æ£€æŸ¥æ‚¨çš„ API Keyã€‚");
            return;
        }

        setLoading(true);

        const payload = {
            model: selectedModel,
            prompt: prompt,
            n: parseInt(countSlider.value, 10),
            size: `${widthSlider.value}x${heightSlider.value}`,
            steps: parseInt(stepsSlider.value, 10),
            response_format: "b64_json"
        };

        try {
            const response = await fetch('/v1/images/generations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            if (!response.ok) {
                throw new Error(result.detail || 'ç”Ÿæˆå¤±è´¥ï¼ŒæœªçŸ¥é”™è¯¯ã€‚');
            }

            if (result.data && result.data.length > 0) {
                displayImages(result.data);
            } else {
                throw new Error('API è¿”å›äº†æˆåŠŸçŠ¶æ€ï¼Œä½†æ²¡æœ‰å›¾ç‰‡æ•°æ®ã€‚');
            }
        } catch (error) {
            showError(error.message);
        } finally {
            setLoading(false);
        }
    }

    function displayImages(data) {
        imageGrid.innerHTML = '';
        data.forEach(item => {
            if (item.b64_json) {
                const imgContainer = document.createElement('div');
                imgContainer.className = 'image-container';
                const img = document.createElement('img');
                img.src = `data:image/png;base64,${item.b64_json}`;
                img.alt = 'Generated Image';
                imgContainer.appendChild(img);
                imageGrid.appendChild(imgContainer);
            }
        });
    }

    function setLoading(isLoading) {
        generateBtn.disabled = isLoading;
        spinner.classList.toggle('hidden', !isLoading);
        placeholder.classList.toggle('hidden', isLoading || imageGrid.children.length > 0);
        if (isLoading) {
            imageGrid.innerHTML = '';
            hideError();
        }
    }

    function showError(message) {
        errorMessage.textContent = message;
        errorMessage.classList.remove('hidden');
        imageGrid.innerHTML = '';
        placeholder.classList.add('hidden');
    }

    function hideError() {
        errorMessage.classList.add('hidden');
    }

    // --- Event Listeners ---
    
    widthSlider.addEventListener('input', () => widthValue.textContent = `${widthSlider.value}px`);
    heightSlider.addEventListener('input', () => heightValue.textContent = `${heightSlider.value}px`);
    stepsSlider.addEventListener('input', () => stepsValue.textContent = stepsSlider.value);
    countSlider.addEventListener('input', () => countValue.textContent = countSlider.value);

    generateBtn.addEventListener('click', handleGenerate);
    modelSelect.addEventListener('change', handleModelChange);
    // When the user finishes editing the API key, try to populate models.
    apiKeyInput.addEventListener('change', populateModels);

    // --- Initial Load ---
    // Attempt to load models as soon as the page is ready.
    populateModels();
});


--- æ–‡ä»¶è·¯å¾„: static\style.css ---

:root {
    --bg-color: #f0f2f5;
    --sidebar-bg: #ffffff;
    --main-bg: #f7f7f8;
    --border-color: #e5e7eb;
    --text-color: #111827;
    --text-secondary: #6b7280;
    --primary-color: #4f46e5;
    --primary-hover: #4338ca;
    --input-bg: #f9fafb;
    --warning-text: #c2410c;
}

* { box-sizing: border-box; }

body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    margin: 0;
    background-color: var(--bg-color);
    color: var(--text-color);
    font-size: 14px;
    display: flex;
    height: 100vh;
    overflow: hidden;
}

.container {
    display: flex;
    width: 100%;
    height: 100%;
}

.sidebar {
    width: 350px;
    flex-shrink: 0;
    background-color: var(--sidebar-bg);
    border-right: 1px solid var(--border-color);
    padding: 24px;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
}

.header {
    padding-bottom: 16px;
    margin-bottom: 24px;
    border-bottom: 1px solid var(--border-color);
}
.header h2 { margin: 0; }
.header p { margin: 4px 0 0; color: var(--text-secondary); }

.main-content {
    flex-grow: 1;
    background-color: var(--main-bg);
    padding: 24px;
    overflow-y: auto;
}

#result-panel {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.form-group { margin-bottom: 20px; }
label { display: block; font-weight: 500; margin-bottom: 8px; }

input[type="password"], textarea, select {
    width: 100%;
    padding: 12px 14px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    font-size: 16px;
    background-color: var(--input-bg);
    transition: border-color 0.2s;
}
textarea { resize: vertical; }
input:focus, textarea:focus, select:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
}

.slider-group .slider-label {
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.slider-group .slider-label span {
    font-weight: 600;
    color: var(--primary-color);
}
.slider-group small, .model-warning {
    display: block;
    margin-top: 6px;
    font-size: 12px;
}
.slider-group small {
    color: var(--text-secondary);
}
.model-warning {
    color: var(--warning-text);
}

input[type="range"] {
    -webkit-appearance: none;
    width: 100%;
    height: 6px;
    background: #ddd;
    border-radius: 5px;
    outline: none;
    margin-top: 8px;
}
input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 18px;
    height: 18px;
    background: var(--primary-color);
    cursor: pointer;
    border-radius: 50%;
}
input[type="range"]::-moz-range-thumb {
    width: 18px;
    height: 18px;
    background: var(--primary-color);
    cursor: pointer;
    border-radius: 50%;
}

#generate-btn {
    width: 100%;
    padding: 12px;
    background-color: var(--primary-color);
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-top: auto;
}
#generate-btn:hover { background-color: var(--primary-hover); }
#generate-btn:disabled { background-color: #9ca3af; cursor: not-allowed; }

.placeholder {
    text-align: center;
    color: var(--text-secondary);
}

#image-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(256px, 1fr));
    gap: 16px;
    width: 100%;
}
.image-container {
    position: relative;
    overflow: hidden;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.image-container img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
}

.hidden { display: none; }

.spinner {
    border: 5px solid rgba(0, 0, 0, 0.1);
    width: 50px;
    height: 50px;
    border-radius: 50%;
    border-left-color: var(--primary-color);
    animation: spin 1s ease infinite;
}
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

.error {
    color: #b91c1c;
    background-color: #fee2e2;
    border: 1px solid #fca5a5;
    padding: 15px;
    border-radius: 6px;
    text-align: center;
    max-width: 600px;
}



